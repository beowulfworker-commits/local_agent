# Локальный Qwen‑агент

Этот документ описывает установку, настройку и использование локального агента, основанного на модели Qwen 2.5‑Coder. Агент развёртывается на вашем компьютере, взаимодействует с моделью через Ollama и предоставляет интерфейс для работы через CLI, HTTP API и простую веб‑страницу.

## Требования

- **WSL/Ubuntu или Linux**. Инструкции ниже предполагают использование bash.
- **Python 3.10+**.
- **Ollama**, установленная через официальный скрипт.
- **Модель `qwen2.5-coder:14b`** (около 9 ГБ).

## Установка

1. **Клонируйте репозиторий** (если вы этого ещё не сделали) и перейдите в его каталог.
2. **Запустите установку бэкенда**:

   ```bash
   bash scripts/install_backend.sh
   ```

   Этот скрипт проверит, установлен ли Ollama, и если нет, загрузит его официальным способом с сайта Ollama. Затем будет скачана модель `qwen2.5-coder:14b`. Процесс может занять значительное время.

3. **Создайте виртуальную среду Python (необязательно)**:

   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

   В текущей версии проекта файл `requirements.txt` может отсутствовать; установите необходимые зависимости вручную:

   ```bash
   pip install fastapi uvicorn pydantic requests PyYAML pytest
   ```

## Запуск

1. **Запустите Ollama‑бэкенд** (сервер моделей):

   ```bash
   bash scripts/run_backend.sh
   ```

   Скрипт запустит `ollama serve` и убедится, что модель уже скачана. Сервер будет слушать на порту `11434`.

2. **Запустите агент**:

   В другом терминале выполните:

   ```bash
   bash scripts/run_agent.sh
   ```

   По умолчанию сервер API будет доступен на `http://localhost:8000`. Для изменения порта установите переменную окружения `PORT`, например `PORT=8080 bash scripts/run_agent.sh`.

## Использование

### Веб‑интерфейс

После запуска агента откройте в браузере:

```
http://localhost:8000/web
```

Вы увидите простую форму для ввода сообщений и область диалога. Галочка «Enable tool calls» позволяет включить использование инструментов. Сообщения отправляются на API `/chat` и результаты отображаются в интерфейсе.

### HTTP API

Базовый эндпоинт:

- `POST /chat` — принимает JSON с полями `message` (строка) и `use_tools` (логическое), возвращает JSON с ответом модели.
- `GET /tools` — возвращает список доступных инструментов с их описаниями и схемами входных параметров.

Пример запроса с помощью `curl`:

```bash
curl -X POST http://localhost:8000/chat \
     -H 'Content-Type: application/json' \
     -d '{"message": "Привет, агент!", "use_tools": false}'
```

### CLI

Для взаимодействия через терминал выполните:

```bash
python3 -m cli.agent_cli --use-tools
```

Опция `--use-tools` включает возможность вызова инструментов. Без неё агент действует как обычный чат‑бот.

## Инструменты

Инструменты представляют собой модули в каталоге `agent/tools/` и реализуют общий протокол `Tool`. В текущей версии доступны:

| Имя        | Описание                                                               | Параметры |
|------------|-------------------------------------------------------------------------|-----------|
| `file_reader` | Читает содержимое файла в репозитории по относительному пути.       | `path` (обязательный), `max_chars` (необязательный) |
| `file_search` | Ищет строку или регулярное выражение в текстовых файлах репозитория. | `query` (обязательный), `max_results` (необязательный) |
| `logger`       | Добавляет строку заметки в файл `notes.txt`.                        | `note` (обязательный) |

## Добавление нового инструмента

1. **Определите требования** (входные параметры, формат результата, назначение).
2. **Создайте модуль** в `agent/tools/<имя_инструмента>.py`. Класс инструмента должен иметь атрибуты `name`, `description`, `input_schema` и метод `run(self, **kwargs)`.
3. **Зарегистрируйте инструмент** в файле `agent/config/tools.yaml`, указав имя, модуль и класс.
4. **Напишите тесты** в `tests/test_<имя_инструмента>.py`.
5. **Обновите документацию** при необходимости.

После этого перезапустите агент. Новый инструмент будет доступен в списке `/tools` и через режим вызова инструментов.

## Разработка и тестирование

Запустить тесты можно командой:

```bash
pytest
```

Тесты покрывают базовые инструменты, ядро агента и API. Рекомендуется писать тесты на каждый новый компонент.

## Расширение функциональности

Проект спроектирован так, чтобы его было легко расширять. Возможные направления развития:

- **Память и контекст**: сохранение истории между сессиями или работа с базой данных.
- **Дополнительные инструменты**: доступ к интернету, управление проектами, интеграция с календарём и т.п.
- **Замена бэкенда**: вместо Ollama можно реализовать класс, совместимый с `LLMBackend`, использующий другие фреймворки (`vLLM`, `transformers`, `llama.cpp`).

## Безопасность

- Инструменты ограничены текущим репозиторием — код не позволяет читать или модифицировать файлы за его пределами.
- Скрипты установки не выполняются автоматически; запускать их нужно вручную.
- Не создавайте инструменты, выполняющие произвольные системные команды, без явного запроса.